package com.cedge.adhaarcardapi.service;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.UnsupportedEncodingException;
import java.net.InetSocketAddress;
import java.net.Proxy;
import java.net.URL;
import java.net.URLConnection;
import java.net.URLEncoder;
import java.sql.Connection;
import java.util.Random;
import org.apache.log4j.Logger;
import org.springframework.stereotype.Service;

import com.cedge.adhaarcardapi.config.DataBaseMaster;
import com.cedge.adhaarcardapi.dao.MandateMasterDao;
import com.cedge.adhaarcardapi.entity.BankConfiguration;

@Service
public class SmsService {

	private final static Logger logger = Logger.getLogger(SmsService.class);

	public String sendSMS(String Mob, BankConfiguration ebd) {
		String otp = getOTP();
		// String stOTPMessage="OTP to authenticate your e-mandate process is #temp,
		// please do not share the OTP with anyone. HAPPY DIGITAL BANKING! - KVG BANK";
		String stOTPMessage = ebd.getSMSTEMPLATE().replace("#temp", otp).trim();
		// stOTPMessage=stOTPMessage.replace("#temp", otp).trim();
		logger.info("SMS:" + stOTPMessage);
		logger.info(otp);
		String userName = "";
		String sender_id = ebd.getSENDERID().trim();
		userName = ebd.getSMSUNAME().trim();
		String passWord = ebd.getSMSPASS().trim();
		logger.info("Sender ID: " + sender_id + "Username: " + userName + "Password: " + passWord);
		String inputLine = "";
		if (Mob == null) {
			Mob = "";
		}
		String reqU = "https://hahttp2.myvfirst.com/smpp/sendsms?";
		String stRemitterMobileNo = Mob.replace("-", "");
		stRemitterMobileNo = stRemitterMobileNo.replace("+", "");
		String stOTPParameters = "username~" + userName + "&password~" + passWord + "&to~mob_no&from~" + sender_id
				+ "&text~text_message";
		stOTPParameters = stOTPParameters.replaceAll("~", "=");
		stOTPParameters = stOTPParameters.replaceAll("mob_no", stRemitterMobileNo.trim());

		try {
			stOTPParameters = stOTPParameters.replaceAll("text_message", URLEncoder.encode(stOTPMessage, "UTF-8"));

		} catch (UnsupportedEncodingException e1) {
			logger.debug("Exception occured while encoding OTP Message: " + e1.getMessage());
		}

		String requestURL1 = reqU.concat(stOTPParameters);
		logger.info("URL:" + requestURL1);

		try {
			Proxy proxy = new Proxy(Proxy.Type.HTTP, new InetSocketAddress("10.43.5.6", new Integer(3128)));//10.1.24.97:8080
			URLConnection yc = new URL(requestURL1).openConnection(proxy);//10.43.5.6 : 3128
			BufferedReader in = new BufferedReader(new InputStreamReader(yc.getInputStream()));
			while ((inputLine = in.readLine()) != null) {
			}
			in.close();
		} catch (Exception e) {
			otp = "otpfail";
			logger.debug("Exception occured while sending SMS: "+e.getMessage());
		}
		return otp;
	}

	public static void main(String args[]) throws IOException {

		Connection conn = DataBaseMaster.getConnection("jdbc:oracle:thin:@10.43.4.15:1532:infuatdb", "infuat", "infuat_123");

		BankConfiguration ebd = MandateMasterDao.getBankDetails("APGVB", conn);
		SmsService sm = new SmsService();
		sm.sendSMS("91-9096241507", ebd);

	}

	public String getOTP() {
		StringBuffer OTP = new StringBuffer("");
		try {
			char[] password = new char[6];
			String values = "0123456789";
			Random rndm_method = new Random();
			for (int i = 0; i < 6; i++) {
				password[i] = values.charAt(rndm_method.nextInt(values.length()));
			}
			for (int i = 0; i < password.length; i++) {
				OTP.append(password[i]);
			}
		} catch (Exception e) {
			logger.debug("Exception occured while generating OTP: " + e.getMessage());
		}
		return OTP.toString();
	}

}
